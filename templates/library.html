<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .book-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .book-title { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .book-meta { color: #666; font-size: 0.9em; margin-bottom: 15px; }
        .btn { display: inline-block; background: #3498db; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; }
        .btn:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Library</h1>

        <div style="margin: 20px 0; padding: 16px; background: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
            <div style="font-weight: 600; margin-bottom: 8px;">添加新书</div>
            <div style="font-size: 0.9em; color: #555; margin-bottom: 8px;">选择 EPUB 文件并选择拆解层级后上传到本地图书馆。</div>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <input id="upload-file" type="file" accept=".epub" />
                <label for="upload-split-level">拆解层级：</label>
                <select id="upload-split-level">
                    <option value="1">1 级（仅 h1）</option>
                    <option value="2" selected>2 级（h1–h2）</option>
                    <option value="3">3 级（到 h3）</option>
                    <option value="4">4 级</option>
                    <option value="5">5 级</option>
                    <option value="6">6 级</option>
                </select>
                <button type="button" class="btn" onclick="uploadFromLibrary()">上传 EPUB</button>
                <span id="upload-status" style="font-size: 0.85em; color: #666;"></span>
            </div>
        </div>

        {% if not books %}
            <p>No processed books found. Use the uploader above or run <code>reader3.py</code> on an epub first.</p>
        {% endif %}

        {% if hub_files %}
        <div style="margin: 24px 0 8px; font-weight: 600;">EPUB 仓库（books/hub）</div>
        <div style="font-size: 0.9em; color: #555; margin-bottom: 12px;">
            从本地 EPUB 仓库中选择文件，按指定拆解层级导入或重新导入到书库。
        </div>
        <div style="background:#ffffff; border-radius:8px; padding:12px 16px; box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            {% for hub in hub_files %}
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px; flex-wrap:wrap;">
                <div style="flex:1 1 auto; font-size:0.9em; color:#374151;">
                    {{ hub.filename }}
                    {% if hub.in_shelf %}
                        <span style="color:#16a34a; margin-left:4px;">（已在书库中）</span>
                    {% endif %}
                </div>
                <select id="hub-split-{{ loop.index0 }}">
                    <option value="1">1 级（仅 h1）</option>
                    <option value="2" selected>2 级（h1–h2）</option>
                    <option value="3">3 级（到 h3）</option>
                    <option value="4">4 级</option>
                    <option value="5">5 级</option>
                    <option value="6">6 级</option>
                </select>
                <button type="button" class="btn" onclick="importFromHub('{{ hub.filename }}', 'hub-split-{{ loop.index0 }}')">
                    {% if hub.in_shelf %}重新导入{% else %}导入{% endif %}
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="book-grid">
            {% for book in books %}
            <div class="book-card">
                <div class="book-title">{{ book.title }}</div>
                <div class="book-meta">
                    {{ book.author }}<br>
                    {{ book.chapters }} sections<br>
                    Split level: {{ book.split_level }}
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                    <a href="/read/{{ book.id }}/0" class="btn">Read Book</a>
                    <button type="button" class="btn" style="background:#ef4444; border-color:#ef4444;" onclick="deleteBook('{{ book.id }}')">Delete</button>
                </div>
                <div style="font-size: 0.85em; color:#555; margin-bottom:4px;">重新拆分此书：</div>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap: wrap;">
                    <select id="split-{{ loop.index0 }}">
                        <option value="1" {% if book.split_level == 1 %}selected{% endif %}>1 级（仅 h1）</option>
                        <option value="2" {% if book.split_level == 2 %}selected{% endif %}>2 级（h1–h2）</option>
                        <option value="3" {% if book.split_level == 3 %}selected{% endif %}>3 级（到 h3）</option>
                        <option value="4" {% if book.split_level == 4 %}selected{% endif %}>4 级</option>
                        <option value="5" {% if book.split_level == 5 %}selected{% endif %}>5 级</option>
                        <option value="6" {% if book.split_level == 6 %}selected{% endif %}>6 级</option>
                    </select>
                    <button type="button" class="btn" onclick="resplitBook('{{ book.id }}', 'split-{{ loop.index0 }}')">重新拆分</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        async function uploadFromLibrary() {
            const fileInput = document.getElementById("upload-file");
            const splitSelect = document.getElementById("upload-split-level");
            const statusEl = document.getElementById("upload-status");

            if (!fileInput.files || !fileInput.files[0]) {
                statusEl.textContent = "请选择一个 EPUB 文件";
                statusEl.style.color = "#b91c1c";
                return;
            }

            statusEl.textContent = "正在上传并解析 EPUB……";
            statusEl.style.color = "#374151";

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("split_level", splitSelect.value || "2");

            try {
                const res = await fetch("/api/upload_epub", {
                    method: "POST",
                    body: formData,
                });
                if (!res.ok) {
                    throw new Error("HTTP " + res.status);
                }
                const data = await res.json();
                statusEl.textContent = "完成：" + (data.title || "书籍") + " 已加入书库";
                statusEl.style.color = "#166534";
                window.location.reload();
            } catch (e) {
                statusEl.textContent = "上传失败：" + e.message;
                statusEl.style.color = "#b91c1c";
            }
        }

        async function deleteBook(bookId) {
            if (!confirm("确定要删除这本书吗？这将删除对应的 _data 目录。")) {
                return;
            }
            try {
                const res = await fetch("/api/books/" + encodeURIComponent(bookId) + "/delete", {
                    method: "POST",
                });
                if (!res.ok) {
                    throw new Error("HTTP " + res.status);
                }
                window.location.reload();
            } catch (e) {
                alert("删除失败：" + e.message);
            }
        }

        async function resplitBook(bookId, selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const level = select.value || "2";

            if (!confirm("按层级 " + level + " 重新拆分这本书？这会重建数据目录。")) {
                return;
            }

            const formData = new FormData();
            formData.append("split_level", level);

            try {
                const res = await fetch("/api/books/" + encodeURIComponent(bookId) + "/resplit", {
                    method: "POST",
                    body: formData,
                });
                if (!res.ok) {
                    throw new Error("HTTP " + res.status);
                }
                window.location.reload();
            } catch (e) {
                alert("重新拆分失败：" + e.message);
            }
        }

        async function importFromHub(filename, selectId) {
            const select = document.getElementById(selectId);
            const level = select ? (select.value || "2") : "2";

            const formData = new FormData();
            formData.append("filename", filename);
            formData.append("split_level", level);

            try {
                const res = await fetch("/api/hub/import", {
                    method: "POST",
                    body: formData,
                });
                if (!res.ok) {
                    throw new Error("HTTP " + res.status);
                }
                window.location.reload();
            } catch (e) {
                alert("从 hub 导入失败：" + e.message);
            }
        }
    </script>
</body>
</html>
